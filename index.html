<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CashDeal — Landing</title>
  <style>
    :root { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; color:#222; }
    body { margin:0; min-height:100vh; display:flex; align-items:center; justify-content:center; background:#f5f6fa; }
    .card { width:520px; max-width:calc(100% - 32px); background:#fff; border-radius:10px; padding:28px; box-shadow:0 6px 30px rgba(16,24,40,0.08); }
    h1 { margin:0 0 8px 0; font-size:20px; }
    p { margin:0 0 18px 0; color:#555; }
    .btn { display:inline-block; padding:10px 14px; border-radius:8px; text-decoration:none; color:#fff; background:#1e90ff; border:none; cursor:pointer; }
    .outline { background:transparent; color:#1e90ff; border:1px solid #1e90ff; margin-left:10px; }
    .meta { margin-top:14px; color:#777; font-size:13px; }
    .loading { display:inline-block; width:14px; height:14px; border-radius:50%; border:2px solid rgba(0,0,0,0.08); border-top-color:#1e90ff; animation:spin 1s linear infinite; vertical-align:middle; margin-right:8px;}
    @keyframes spin { to { transform:rotate(360deg); } }
    .hidden { display:none; }
    .small { font-size:13px; color:#666; margin-top:10px; }
  </style>
</head>
<body>
  <div class="card" id="card">
    <div id="loadingRow" class="">
      <span class="loading" id="spinner" style="display:none"></span>
      <strong id="status">Checking session…</strong>
      <div class="meta" id="meta">This page connects your existing login/signup/admin pages to Firebase and routes users.</div>
    </div>

    <div id="not-signed-in" class="hidden">
      <h1>Welcome to CashDeal</h1>
      <p>Sign in to access your dashboard. If you don't have an account create one.</p>
      <div>
        <a class="btn" href="login.html" id="btnLogin">Login</a>
        <a class="btn outline" href="signup.html" id="btnSignup">Sign up</a>
      </div>
      <div class="small">If you're an admin, sign in and you'll be redirected to the admin console automatically.</div>
    </div>

    <div id="signed-in" class="hidden">
      <h1 id="welcomeTitle">Welcome</h1>
      <p id="welcomeMsg"></p>
      <div>
        <button class="btn" id="btnContinue">Continue</button>
        <button class="btn outline" id="btnSignout">Sign out</button>
      </div>
      <div class="small">If you're an admin you'll be taken to admin.html; otherwise to dashboard.html.</div>
    </div>
  </div>

  <script type="module">
    import { auth, db } from './app.js';
    import { onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/9.21.0/firebase-auth.js';
    import { getDoc, doc } from 'https://www.gstatic.com/firebasejs/9.21.0/firebase-firestore.js';

    // UI elements
    const statusEl = document.getElementById('status');
    const spinner = document.getElementById('spinner');
    const notSignedIn = document.getElementById('not-signed-in');
    const signedIn = document.getElementById('signed-in');
    const welcomeTitle = document.getElementById('welcomeTitle');
    const welcomeMsg = document.getElementById('welcomeMsg');
    const btnContinue = document.getElementById('btnContinue');
    const btnSignout = document.getElementById('btnSignout');

    function showLoading(text = 'Checking session…') {
      statusEl.textContent = text;
      spinner.style.display = 'inline-block';
      notSignedIn.classList.add('hidden');
      signedIn.classList.add('hidden');
    }

    function showNotSignedIn() {
      spinner.style.display = 'none';
      statusEl.textContent = 'Not signed in';
      notSignedIn.classList.remove('hidden');
      signedIn.classList.add('hidden');
    }

    function showSignedIn(user) {
      spinner.style.display = 'none';
      welcomeTitle.textContent = `Welcome, ${user.displayName || user.email || user.uid}`;
      welcomeMsg.textContent = `Signed in as ${user.email || user.uid}. Choose Continue to go to your dashboard.`;
      notSignedIn.classList.add('hidden');
      signedIn.classList.remove('hidden');
    }

    // Keep a reference to last seen user doc role to avoid double fetch
    let lastRole = null;
    let lastUserUid = null;

    // Start UI
    showLoading();

    onAuthStateChanged(auth, async (user) => {
      try {
        if (!user) {
          // no user — show sign in links
          showNotSignedIn();
          return;
        }

        // user exists — show signed-in UI while we determine role
        showSignedIn(user);
        statusEl.textContent = 'Detecting user role…';
        spinner.style.display = 'inline-block';

        // fetch role from users collection (users/<uid>)
        const uRef = doc(db, 'users', user.uid);
        const uSnap = await getDoc(uRef);

        let role = 'user';
        if (uSnap.exists()) {
          const data = uSnap.data();
          role = data.role || 'user';
        }

        lastRole = role;
        lastUserUid = user.uid;

        spinner.style.display = 'none';
        statusEl.textContent = `Signed in as ${role}`;

        // Continue button routes user based on role
        btnContinue.onclick = () => {
          if (role === 'admin') {
            window.location.href = 'admin.html';
          } else {
            // Use dashboard.html (adjust path if your user dashboard is named differently)
            window.location.href = 'dashboard.html';
          }
        };

      } catch (err) {
        console.error('Error while handling auth state:', err);
        spinner.style.display = 'none';
        statusEl.textContent = 'Error detecting session';
        notSignedIn.classList.remove('hidden');
      }
    });

    // Sign out
    btnSignout.addEventListener('click', async () => {
      try {
        await signOut(auth);
        showNotSignedIn();
      } catch (err) {
        console.error('Sign out error', err);
        alert('Error signing out: ' + err.message);
      }
    });
  </script>
</body>
</html>
