<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Admin — CashDeal</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; padding:24px; background:#f5f6fa; }
    table { border-collapse: collapse; width:100%; background:white; border-radius:8px; overflow:hidden; box-shadow:0 6px 20px rgba(0,0,0,0.06); }
    th, td { padding:12px 10px; border-bottom:1px solid #eee; text-align:left; }
    th { background:#fafafa; }
    input[type=number] { width:120px; padding:6px; border:1px solid #ddd; border-radius:6px; }
    button { padding:8px 10px; border-radius:6px; border:none; cursor:pointer; }
    .btn-save { background:#1e90ff; color:white; }
    .btn-logout { background:#eee; margin-left:8px; }
    .header { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
    #logs { margin-top:16px; background:white; padding:12px; border-radius:8px; box-shadow:0 6px 20px rgba(0,0,0,0.04); }
  </style>
</head>
<body>
  <div class="header">
    <div>
      <strong>Admin Console</strong><br />
      <small>Signed in as: <span id="admin-email">...</span></small>
    </div>
    <div>
      <button id="btn-refresh">Refresh</button>
      <button id="btn-signout" class="btn-logout">Sign out</button>
    </div>
  </div>

  <table id="users-table" aria-label="Users table">
    <thead><tr><th>Email</th><th>Balance</th><th>Role</th><th>Actions</th></tr></thead>
    <tbody></tbody>
  </table>

  <div id="logs"><strong>Selected user logs will appear here</strong></div>

  <script type="module">
    import { auth, db } from './firebase-init.js';
    import { onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/9.21.0/firebase-auth.js';
    import {
      collection, getDocs, doc, getDoc, updateDoc, query, where, orderBy, addDoc, serverTimestamp
    } from 'https://www.gstatic.com/firebasejs/9.21.0/firebase-firestore.js';

    const adminEmailEl = document.getElementById('admin-email');
    const usersTableBody = document.querySelector('#users-table tbody');
    const logsDiv = document.getElementById('logs');
    const btnSignout = document.getElementById('btn-signout');
    const btnRefresh = document.getElementById('btn-refresh');

    let currentAdminUid = null;

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = 'login.html';
        return;
      }

      currentAdminUid = user.uid;
      adminEmailEl.textContent = user.email || user.uid;

      // verify admin role
      try {
        const aSnap = await getDoc(doc(db, 'users', user.uid));
        if (!aSnap.exists() || aSnap.data().role !== 'admin') {
          alert('Access denied: you are not an admin.');
          await signOut(auth);
          window.location.href = 'login.html';
          return;
        }
      } catch (err) {
        console.error('Role check error', err);
        alert('Error checking admin role — see console.');
        await signOut(auth);
        window.location.href = 'login.html';
        return;
      }

      // load users
      await loadUsers();
    });

    btnSignout.addEventListener('click', async () => {
      await signOut(auth);
      window.location.href = 'login.html';
    });

    btnRefresh.addEventListener('click', loadUsers);

    async function loadUsers() {
      usersTableBody.innerHTML = '';
      logsDiv.innerHTML = '<strong>Selected user logs will appear here</strong>';
      try {
        const snap = await getDocs(collection(db, 'users'));
        snap.forEach(docSnap => {
          const d = docSnap.data();
          const tr = document.createElement('tr');

          const emailCell = document.createElement('td');
          emailCell.textContent = d.email || docSnap.id;

          const balanceCell = document.createElement('td');
          const input = document.createElement('input');
          input.type = 'number';
          input.step = '0.01';
          input.value = Number(d.balance || 0);
          input.dataset.uid = docSnap.id;
          balanceCell.appendChild(input);

          const roleCell = document.createElement('td');
          roleCell.textContent = d.role || 'user';

          const actionsCell = document.createElement('td');
          const saveBtn = document.createElement('button');
          saveBtn.className = 'btn-save';
          saveBtn.textContent = 'Save';
          saveBtn.dataset.uid = docSnap.id;
          const viewLogsBtn = document.createElement('button');
          viewLogsBtn.textContent = 'View logs';
          viewLogsBtn.dataset.uid = docSnap.id;
          viewLogsBtn.style.marginLeft = '8px';

          actionsCell.appendChild(saveBtn);
          actionsCell.appendChild(viewLogsBtn);

          tr.appendChild(emailCell);
          tr.appendChild(balanceCell);
          tr.appendChild(roleCell);
          tr.appendChild(actionsCell);

          usersTableBody.appendChild(tr);
        });

        // wire up actions
        usersTableBody.querySelectorAll('button.btn-save').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const uid = btn.dataset.uid;
            const input = usersTableBody.querySelector(`input[data-uid="${uid}"]`);
            const newBalance = Number(input.value || 0);

            try {
              // update user balance (client-side update)
              await updateDoc(doc(db, 'users', uid), {
                balance: newBalance,
                lastAction: `edited by admin:${currentAdminUid}`
              });

              // log admin action
              await addDoc(collection(db, 'admin_actions'), {
                adminUid: currentAdminUid,
                targetUid: uid,
                newBalance,
                ts: serverTimestamp()
              });

              alert('Balance updated');
              await loadUsers();
            } catch (err) {
              console.error('Error updating balance', err);
              alert('Error updating balance: ' + (err.message || err));
            }
          });
        });

        usersTableBody.querySelectorAll('button').forEach(btn => {
          if (btn.textContent === 'View logs') {
            btn.addEventListener('click', async () => {
              const uid = btn.dataset.uid;
              await showLogsFor(uid);
            });
          }
        });

      } catch (err) {
        console.error('Error loading users', err);
        alert('Could not load users: ' + (err.message || err));
      }
    }

    async function showLogsFor(uid) {
      logsDiv.innerHTML = 'Loading logs…';
      try {
        const q = query(collection(db, 'auth_logs'), where('uid', '==', uid), orderBy('ts', 'desc'));
        const snap = await getDocs(q);
        if (snap.empty) {
          logsDiv.innerHTML = '<div>No logs found.</div>';
          return;
        }
        const ul = document.createElement('ul');
        snap.forEach(s => {
          const d = s.data();
          const when = d.ts && d.ts.toDate ? d.ts.toDate().toISOString() : 'unknown';
          const li = document.createElement('li');
          li.textContent = `${when} — ${d.action} — ${d.email || uid} — ${d.userAgent || ''}`;
          ul.appendChild(li);
        });
        logsDiv.innerHTML = '<h3>Auth logs</h3>';
        logsDiv.appendChild(ul);
      } catch (err) {
        console.error('Error loading logs', err);
        logsDiv.innerHTML = '<div>Error loading logs (see console)</div>';
      }
    }
  </script>
</body>
</html>
